import { sum } from "d3-array";
import {geoProjection as projection} from "d3-geo";
import {hammerRaw} from "./hammer.js";
import {cos, pi, sin} from "./math.js";
import {solve2d} from "./newton.js";

// Bertin 1953 as a modified Briesemeister
// https://bl.ocks.org/Fil/5b9ee9636dfb6ffa53443c9006beb642
export function bertin1953Raw() {
  var hammer = hammerRaw(1.68, 2);
  var xijs = [(1, 0), (1, 1), (1, 2), (1, 3), (1, 4), (1, 5), (1, 6), (1, 7), (1, 8), (1, 9)];
  var yijs = [(0, 0), (0, 1), (0, 2), (0, 3), (0, 4), (0, 5), (0, 6), (0, 7), (0, 8), (0, 9), (0, 10)];
  var C = [ [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.5963281974814849,0.017274974591818815,0.11905342599814848,0.06791577862129425,-0.47991070279323705,-0.02903494222245918,0.5161250171931101,0.010324885156031083,-0.1339286293826542,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-0.019347121394919255,-0.04580497273234699,0.020587587589533243,-0.0020913505677701513,0.1277186387037678,-0.004310137840616445,-0.09370524912806863,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.0087954817801464,0.017702828185555783,-0.01857190789145824,-0.001443374172712267,-0.002620294671830502,0.0,0.0,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-0.001042611554922211,-0.0015063997498861875,0.0014748580224780874,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [3.346009783516168e-5,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
          ]
  var Cp = [[0.18695642304065999,1.7663053885174658,-0.0014574116866248378,0.35703917799875207,-0.1433745337827682,-0.23314323401546022,0.19855951243597691,0.06464430025276377,-0.07673834383546589,-0.0028758303069844225],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-0.07612341544834092,0.2916704746854383,0.11326399095683558,-0.2074720838604522,-0.25423879276879774,0.05919984410286129,0.08394989528329813,-0.02042007321859014,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.025236337655759944,-0.12741960039182557,-0.0657455710837663,0.05772499342721642,0.050274563492548635,0.00011398558611500291,0.0,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [-0.007351564250747409,0.02959289515619907,0.0072504328257137944,-0.009648371485670734,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.0005567777189153381,-0.002091335565843744,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
            [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
          ]

  function hammerBaseTerm(lambda, phi, i, j) {
    var r = hammer(lambda, phi);
    return (r[0]**i * r[1]**j);
  }

  function forward(lambda, phi) {
    return [
      sum(xijs.map((i, j) => C[i][j] * hammerBaseTerm(lambda, phi, i, j))),
      sum(yijs.map((i, j) => Cp[i][j] * hammerBaseTerm(lambda, phi, i, j)))
    ];
  }

  forward.invert = solve2d(forward);
  return forward;
}

export default function() {
  // this projection should not be rotated
  return projection(bertin1953Raw())
    .rotate([-16.5, -42])
    .scale(176.57)
    .center([7.93, 0.09]);
}
